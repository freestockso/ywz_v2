function Ou_Communicate(a){var b={backend:"",tokenName:"",tokenValue:"",lostCount:5};var d=$.extend(b,a);var c=d.lostCount;this.send=function(e,h){var g=new Date().getTime();var f={tokenName:d.tokenName,tokenValue:d.tokenValue,sendTime:g,playload:e};console.log("Communicate Send:",f);$.ajax({url:d.backend,type:"post",data:f,cache:false,dataType:"json",success:function(i){console.log("Communicate recv:",i);if(i.success=="false"){console.log(i.msg)}c=d.lostCount;$(window).trigger("RecvData",i);if(typeof h==="function"){h(i)}},error:function(){if(c>0){c--}else{$(window).trigger("ServerLost")}console.log("Server lost :"+c);if(typeof h==="function"){h(null)}},complete:function(){console.log("Communicate delay(ms)="+(new Date().getTime()-g),typeof h)}})}}function Ou_playPage(c){var j={blkForceLayer:"blkForceLayer"};var d={tabScrolling:false};var f=this;var g={};var i=function(){var o={};this.createOnline=function(v,u,t,s,q,r,p){o[v]={BEid:u,starttime:t,endtime:s,objtype:q,refid:r,FEobj:p};console.log(o)};this.getOnlineTable=function(){return o};this.setOnline=function(t,q,s,p){var r=parseInt((new Date()).getTime()/1000);console.log("setting online..");if(o[t]["starttime"]>0&&(r-o[t]["endtime"])<20&&o[t]["objtype"]==q&&o[t]["refid"]==s){o[t]["endtime"]=0}else{o[t]["BEid"]=0;o[t]["starttime"]=r;o[t]["endtime"]=0;o[t]["objtype"]=q;o[t]["refid"]=s;o[t]["FEobj"]=p}console.log(o)};this.setOffline=function(q){var p=parseInt((new Date()).getTime()/1000);console.log("setting offline..");o[q]["endtime"]=p;console.log(o)};this.procFeedback=function(t){var s=Object.keys(o);var u=0;for(var r=0,p=s.length;r<p;r++){var q=s[r];if((o[q]["starttime"]==t[q]["starttime"])&&(t[q]["BEid"]>0)){if(t[q]["endtime"]==0){o[q]["BEid"]=t[q]["BEid"];if(t[q]["reject"]==true){u=(q=="web")?2:1}}else{o[q]["BEid"]=o[q]["starttime"]=o[q]["endtime"]=o[q]["FEobj"]=0}}}console.log("procFeedback output table: ",o);return u};return this}();function e(r,q){var o=null;q=parseInt(q)*1000;if(q<1000){q=10*1000}var p=function(){r();if(null!=o){clearTimeout(o)}o=setTimeout(p,q)};this.reset=function(){p()};this.stop=function(){if(null!=o){clearTimeout(o)}};this.reset();console.log("Ou_KeepAlive start.")}var a=parseInt((new Date()).getTime()/1000);i.createOnline("web",c.onlineid,a,0,"web",c.chnid,null);i.createOnline("live",0,0,0,"live",c.chnid,null);i.createOnline("vod",0,0,0,"vod",0,null);var l=new Ou_Communicate({backend:c.appUrl+"/BE_communicate/server",tokenName:"playToken",tokenValue:c.playToken});this.send=function(o,p){o.onlineTable=i.getOnlineTable();o.appPara=g;l.send(o,p)};this.setAppPara=function(p,o){if("undefined"==typeof(g[p])){g[p]={}}g[p]=$.extend(g[p],o)};var b=new e(function(){f.send({})},c.aliveTime);$(window).on("RecvData",function(o,r){var q=this;console.log("recvData proc onlineTable");if("object"==typeof(r.onlineTable)){var p=i.procFeedback(r.onlineTable);console.log("reject=",p);if(1==p){k.pause();i.setOffline("vod");i.setOffline("live");q.send({});alert("已经暂停播放")}else{if(2==p){b.stop();k.dispose();i.setOffline("web");i.setOffline("vod");i.setOffline("live");q.send({});alert("您的账号从别的地方登录或被强制下线，若非本人操作，请立即修改密码！");window.location.href=c.homeUrl}}}});$(window).on("ServerLost",function(o){k.dispose();$("#"+j.blkForceLayer).show();$("#"+j.blkForceLayer).html("与服务器失去联系");b.stop()});if(!c.showCover){$("#blkCover").hide()}$("#btnEnterChannel").on("click",function(){$("#blkCover div").hide();$("#blkCover").animate({right:"100%"})});var m=function(o,p){var q={id:"prismPlayer",width:"100%",height:"100%",autoplay:false,isLive:true,skinLayout:[{name:"bigPlayButton",align:"blabs",x:30,y:80},{name:"H5Loading",align:"cc"},{name:"errorDisplay",align:"tlabs",x:0,y:0},{name:"infoDisplay"},{name:"tooltip",align:"blabs",x:0,y:56},{name:"thumbnail"},{name:"controlBar",align:"blabs",x:0,y:0,children:[{name:"progress",align:"blabs",x:0,y:44},{name:"playButton",align:"tl",x:15,y:12},{name:"timeDisplay",align:"tl",x:10,y:7},{name:"fullScreenButton",align:"tr",x:10,y:12}]}],rePlay:false,playsinline:true,cover:"/t/1.jpg",controlBarVisibility:"hover",useH5Prism:true,x5_fullscreen:true,x5_video_position:"top"};q=$.extend(q,p);if("live"==q.playType){q.isLive=true}else{q.isLive=false}return new Aliplayer(q,function(r){console.log("player ready!");r.on("error",function(s){console.log("player error!!====",s);i.setOffline(q.playType);$(".prism-ErrorMessage").hide();r.setCover(c.cover)});r.on("play",function(s){console.log("player play.====",q);if(q.isLive){i.setOnline("live","live",q.chnid,0);i.setOffline("vod")}else{i.setOnline("vod","vod",q.vodid,0);i.setOffline("live")}});r.on("pause",function(s){console.log("player pause.====",q);i.setOffline(q.playType)});r.on("ended",function(s){console.log("player ended.====");i.setOffline(q.playType)})})};var k=m("prismPlayer",c);this.reloadPlayer=function(q,o,r,p){console.log("reloading player. type=",q,o,r,p);k.pause();c.playType=q;c.source=o;c.cover=r;if("live"==q){c.chnid=p;c.vodid=0}else{c.vodid=p}k.dispose();k=m("prismPlayer",c)};this.getPlayer=function(){return k};var h=function(q){console.log(q);var p=q.activetab;var o=$("#"+q.tabBar);var s=$("#"+q.tabBlk);var u=function(x){var w=s.width();console.log("scrollWidth="+w);var v=o.find(">div[tabOrder='"+x+"']").attr("tabid");v=parseInt(v);s.trigger("tabActive",[v,q]);o.find(">div[tabid='"+p+"']").removeClass("tab-selected");p=v;o.find(">div[tabid='"+p+"']").addClass("tab-selected");d.tabScrolling=true;$("#blkSouth").animate({scrollLeft:(x*w)},300,function(){setTimeout(function(){d.tabScrolling=false},100)})};o.on("click",function(v){var x=v.target;var w=$(x).attr("tabOrder");u(w)});s.scroll(function(){console.log("scroll even");if(d.tabScrolling){return}clearTimeout($.data(this,"scrollTimer"));$.data(this,"scrollTimer",setTimeout(function(){var x=s.scrollLeft();var v=s.width();var w=Math.round(x/v);u(w)},250))});var r={};s.bind("tabActive",function(A,y,v){var x=$("#"+c.tabItemPrefix+y);console.log("recive event:"+y);switch(y){case 101:console.log("101直播");if(true!=r[y]){$.ajaxSetup({async:false});x.load(c.appUrl+"/Play/showChnInfo",{chnid:c.chnid});r[y]=true}console.log("取直播播放地址及cover");var w={chnid:c.chnid,agent:c.agent,playToken:c.playToken};$.post(c.appUrl+"/Play/getLiveSourceJson",w,function(B){console.log("getLiveSourceJson",B);if(null==B){alert("错误: 无法访问服务器")}else{if(B.success!="true"){alert(B.msg)}else{f.reloadPlayer("live",B.source,B.cover,c.chnid)}}},"json");var z=window.location.protocol+"//"+window.location.host;z+="/play.html?ch="+c.chnid;history.replaceState(null,null,z);break;case 110:if(true!=r[y]){x.load(c.appUrl+"/Play/showChnInfo",{chnid:c.chnid});r[y]=true}break;case 102:if(true!=r[y]){x.load(c.appUrl+"/WebChat3/webChat",{channelId:c.chnid});r[y]=true}break;case 104:if(true!=r[y]){x.load(c.appUrl+"/Play/vodlist",{chnid:c.chnid,vodid:c.vodid,playToken:c.playToken});r[y]=true}break;case 105:if(true!=r[y]){x.load(c.appUrl+"/Channel/showPhoto",{chnId:c.chnid});r[y]=true}break;case 106:if(true!=r[y]){x.load(c.appUrl+"/My/showMyInfo/chnid/"+c.chnid);r[y]=true}break;case 109:if(true!=r[y]){x.html("");$("#pictxt").appendTo(x);$("#pictxt").load(c.appUrl+"/FE_PicTxt/init",{chnid:c.chnid,programid:c.vodid});$("#pictxt").show();r[y]=true}break}});s.bind("tabActive",function(x,w,v){});var t=o.find(">div[tabid='"+p+"']").attr("taborder");if(typeof(t)=="undefined"){t=0}u(t)}({tabBar:"tabBar",tabBlk:"blkSouth",activetab:c.activetab});switch(c.forceLayer){case"register":var n={chnid:c.chnid,vidid:c.vodid,tab:c.activetab,agent:c.agent};$("#"+j.blkForceLayer).load(c.appUrl+"/My/showChnRegister",n);break}if(c.forceLayer!="hide"){$("#"+j.blkForceLayer).show()}else{$("#"+j.blkForceLayer).hide()}this.popup=function(q,p,r){var o=$("#win_popup");if(null!=q){o.find(".win_notify").html(q)}if(null!=q){o.find("button").html(p)}o.show();o.find("button").on("click",function(){console.log("popup click");o.find("button").off("click");o.hide();if("function"==typeof r){r()}})};!function(p){var o=3600;var s=60;var t=10;p=parseInt(p);if(p<s){p=o}var r=p;var q=setInterval(function(){r-=t;console.log("idleTimrer countdown=",r);if(r<=s){f.popup("您已经观看很久了，请休息一会","再看一会儿",function(){r=p})}if(r<0){console.log("foce out===");b.stop();clearInterval(q);k.dispose();i.setOffline("web");i.setOffline("vod");i.setOffline("live");f.send({});f.popup("您太久没活动了，已被强制退出","到首页看看",function(){window.location.href=c.homeUrl})}},t*1000);$(window).on("touchstart click",function(){r=p})}(c.operatorIdleInt);this.getParam=function(){return c}};