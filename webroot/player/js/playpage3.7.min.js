function Ou_Communicate(a){var b={backend:"",tokenName:"",tokenValue:"",lostCount:15};var d=$.extend(b,a);var c=d.lostCount;this.send=function(e,h){var g=new Date().getTime();var f={tokenName:d.tokenName,tokenValue:d.tokenValue,sendTime:g,playload:e};console.log("Communicate Send:",f);$.ajax({url:d.backend,type:"post",data:f,cache:false,async:true,dataType:"json",success:function(i){console.log("Communicate recv:",i);if(i.success=="false"){console.log(i.msg);if(c>0){c--}else{$(window).trigger("ServerLost")}}else{c=d.lostCount;$(window).trigger("RecvData",i);if(typeof h==="function"){h(i)}}},error:function(){if(c>0){c--}else{$(window).trigger("ServerLost")}console.log("Server lost :"+c);if(typeof h==="function"){h(null)}},complete:function(){console.log("Communicate delay(ms)="+(new Date().getTime()-g),typeof h)}})}}function Ou_OnlineTableC(){var a={};this.createOnline=function(h,g,f,e,c,d,b){a[h]={BEid:g,starttime:f,endtime:e,objtype:c,refid:d,FEobj:b};console.log(a)};this.getOnlineTable=function(){return a};this.setOnline=function(f,c,e,b){var d=parseInt((new Date()).getTime()/1000);console.log("setting online..",f,c,e,d,a[f]["starttime"]);if(a[f]["starttime"]>0&&(d-a[f]["endtime"])<20&&a[f]["objtype"]==c&&a[f]["refid"]==e){a[f]["endtime"]=0}else{a[f]["BEid"]=0;a[f]["starttime"]=d;a[f]["endtime"]=0;a[f]["objtype"]=c;a[f]["refid"]=e;a[f]["FEobj"]=b}console.log(a)};this.setOffline=function(c){var b=parseInt((new Date()).getTime()/1000);console.log("setting offline..",c,b);if(a[c]["starttime"]>0){a[c]["endtime"]=b}console.log(a)};this.procFeedback=function(f){var e=Object.keys(a);var g=0;for(var d=0,b=e.length;d<b;d++){var c=e[d];if((a[c]["starttime"]==f[c]["starttime"])){if(f[c]["endtime"]==0){if(f[c]["BEid"]>0){a[c]["BEid"]=f[c]["BEid"]}if(f[c]["reject"]==true){g=(c=="web")?2:1}}else{a[c]["BEid"]=a[c]["starttime"]=a[c]["endtime"]=a[c]["FEobj"]=0}}}console.log("procFeedback output table: ",a);return g}}function Ou_KeepAlive(e,d){var a=null;d=parseInt(d);if(5>d){d=5}if(120<d){d=120}var c=d*1000;var b=function(){e();if(null!=a){clearTimeout(a)}a=setTimeout(b,c)};this.reset=function(){a=setTimeout(b,c)};this.stop=function(){if(null!=a){clearTimeout(a)}};this.reset();console.log("Ou_KeepAlive start.")}function Ou_playPage(d){var k={blkForceLayer:"blkForceLayer",blkAirTime:".layerVideoTop2 .blk_airTime",blkLeftTime:".layerVideoTop2 .blk_leftTime",layerVideoTop1:".layerVideoTop1",layerVideoTop2:".layerVideoTop2"};var f={tabScrolling:false,playerReady:false};var g=this;var h={chnid:d.chnid,user:{uid:d.uid,userName:d.userName,account:d.account}};var j=new Ou_OnlineTableC();var b=parseInt((new Date()).getTime()/1000);j.createOnline("web",d.onlineid,b,0,"web",d.chnid,null);j.createOnline("live",0,0,0,"live",d.chnid,null);j.createOnline("vod",0,0,0,"vod",0,null);var m=new Ou_Communicate({backend:d.appUrl+"/BE_communicate/server",tokenName:"playToken",tokenValue:d.playToken});this.send=function(q,r){var p=l.getStatus();console.log("playstatus=",p,"playType=",d.playType);if("error"==p||"ended"==p){j.setOffline(d.playType)}q.onlineTable=j.getOnlineTable();q.appPara=h;m.send(q,r)};this.setAppPara=function(q,p){if("undefined"==typeof(h[q])){h[q]={}}h[q]=$.extend(h[q],p)};var c=new Ou_KeepAlive(function(){g.send({})},d.aliveTime);$(window).on("RecvData",function(p,r){console.log("recvData proc onlineTable");if("object"==typeof(r.onlineTable)){var q=j.procFeedback(r.onlineTable);console.log("reject=",q);if(1==q){l.pause();j.setOffline("vod");j.setOffline("live");g.send({});alert("已经暂停播放")}else{if(2==q){c.stop();l.dispose();j.setOffline("web");j.setOffline("vod");j.setOffline("live");g.send({});alert("您的账号从别的地方登录或被强制下线，若非本人操作，请立即修改密码！");window.location.href=d.homeUrl}}}});$(window).on("ServerLost",function(p){l.dispose();$("#"+k.blkForceLayer).show();$("#"+k.blkForceLayer).html("与服务器失去联系或通讯错误");c.stop()});var n=function(p,q){var r={id:"prismPlayer",width:"100%",height:"100%",autoplay:false,isLive:true,rePlay:false,playsinline:true,preload:false,autoplay:false,cover:"/t/1.jpg",controlBarVisibility:"click",useH5Prism:true,x5_fullscreen:true,x5_video_position:"top"};r=$.extend(r,q);if("live"==r.playType){r.isLive=true}else{r.isLive=false}if(""==r.source){r.skinLayout=[];$(k.blkLeftTime).html("没有信号")}else{r.skinLayout=[{name:"bigPlayButton",align:"cc",x:30,y:80},{name:"H5Loading",align:"cc"},{name:"errorDisplay",align:"tlabs",x:0,y:0},{name:"infoDisplay"},{name:"tooltip",align:"blabs",x:0,y:56},{name:"thumbnail"},{name:"controlBar",align:"blabs",x:0,y:0,children:[{name:"progress",align:"blabs",x:0,y:44},{name:"playButton",align:"tl",x:15,y:12},{name:"timeDisplay",align:"tl",x:10,y:7},{name:"fullScreenButton",align:"tr",x:10,y:12}]}]}return new Aliplayer(r,function(s){console.log("player ready!");f.playerReady=true;s.on("error",function(t){console.log("player error!!====",t,r.playType);j.setOffline(r.playType);$(".prism-ErrorMessage").hide();s.setCover(d.cover)});s.on("canplay",function(){console.log("canplay=======")});s.on("play",function(t){console.log("player On play.====",r);$(k.layerVideoTop2).hide();if(r.isLive){j.setOnline("live","live",r.chnid,0);j.setOffline("vod")}else{j.setOnline("vod","vod",r.vodid,0);j.setOffline("live")}});s.on("pause",function(t){console.log("player pause.====",r.playType);j.setOffline(r.playType)});s.on("ended",function(t){console.log("player ended.====",r.playType);j.setOffline(r.playType)})})};console.log("befor init player.");var l=n("prismPlayer",d);console.log("status.playerReady=",f.playerReady);this.reloadPlayer=function(r,p,s,q){console.log("reloading player. type=",r,p,s,q,f.playerReady,typeof l,l);d.playType=r;d.source=p;d.cover=s;if("live"==r){d.chnid=q;d.vodid=0}else{d.vodid=q}if("object"==typeof l){l.pause();l.dispose()}l=n("prismPlayer",d)};this.getPlayer=function(){return l};var e=function(){if("live"==d.playType&&d.airTime.length>2){if(d.isAdmin!=1){$(".blk_video .prism-big-play-btn").css("display","none")}var q=new Date(Date.parse(d.airTime.replace(/-/g,"/")));var p=Math.floor(q.getTime()/1000);var r=setInterval(function(){var w=new Date();var v=Math.floor(w.getTime()/1000);var u=p-v;var t,A,z,x,B;if(u>0){z=Math.floor(u/3600);if(z<10){z="0"+z}x=Math.floor((u%3600)/60);if(x<10){x="0"+x}B=(u%3600)%60;if(B<10){B="0"+B}t=z+":"+x+":"+B;$(k.blkLeftTime).html("开播倒计时："+t);if(d.isAdmin!=1){$(".blk_video .prism-big-play-btn").css("display","none")}}else{clearInterval(r);if(d.airDuration.length>1){var y=parseInt(d.airDuration);if(p+y>v){$(".blk_video .prism-big-play-btn").css("display","block")}else{$(k.blkLeftTime).html("直播已结束");if(d.isAdmin!=1){$(".blk_video .prism-big-play-btn").css("display","none")}}}else{$(".blk_video .prism-big-play-btn").css("display","block")}}},1000)}};this.setUrl=function(){var p="play.html?ch="+d.chnid;if(d.playType=="vod"){p+="&vf="+d.vodid}if(d.uid>=100){p+="&du="+d.uid}console.log("url changed to=",p);history.replaceState(null,null,p+"#");try{p=window.location.href;var q={url:p};$.post(d.getgetSignUrl,q,function(s){console.log(s);wx.config({debug:false,appId:s.appId,timestamp:s.timestamp,nonceStr:s.noncestr,signature:s.signature,jsApiList:["updateAppMessageShareData","updateTimelineShareData","onMenuShareWeibo","onMenuShareQZone"]});wx.ready(function(){console.log("WX ready====url:",p,d.logoImg);wx.updateAppMessageShareData({title:d.title,desc:d.desc,link:p,imgUrl:d.logoImg,success:function(){}});wx.updateTimelineShareData({title:d.title,link:p,imgUrl:d.logoImg,success:function(){}})})},"json")}catch(r){console.log(r)}};var i=function(r){console.log(r);var q=r.activetab;var p=$("#"+r.tabBar);var t=$("#"+r.tabBlk);var v=function(y){var x=t.width();console.log("scrollWidth="+x);var w=p.find(">div[tabOrder='"+y+"']").attr("tabid");w=parseInt(w);p.find(">div[tabid='"+q+"']").removeClass("tab-selected");q=w;p.find(">div[tabid='"+q+"']").addClass("tab-selected");f.tabScrolling=true;$("#blkSouth").animate({scrollLeft:(y*x)},300,function(){t.trigger("tabActive",[w,r]);setTimeout(function(){f.tabScrolling=false},100)})};p.on("click",function(w){var y=w.target;console.log(y);var x=$(y).attr("tabOrder");v(x)});t.scroll(function(){if(f.tabScrolling){return}clearTimeout($.data(this,"scrollTimer"));$.data(this,"scrollTimer",setTimeout(function(){var y=t.scrollLeft();var w=t.width();var x=Math.round(y/w);v(x)},250))});var s={};t.bind("tabActive",function(A,z,w){var y=$("#"+d.tabItemPrefix+z);console.log("recive event:"+z);switch(z){case 101:console.log("101直播");if(true!=s[z]){$.ajaxSetup({async:true});y.load(d.appUrl+"/Play/showChnInfo",{chnid:d.chnid});s[z]=true}console.log("取直播播放地址及cover");var x={chnid:d.chnid,agent:d.agent,playToken:d.playToken};$.post(d.appUrl+"/Play/getLiveSourceJson",x,function(B){console.log("getLiveSourceJson",B);if(null==B){alert("错误: 无法访问服务器")}else{if(B.success!="true"){alert(B.msg)}else{g.reloadPlayer("live",B.source,B.cover,d.chnid)}}},"json");g.setUrl();$(k.layerVideoTop2).show();break;case 110:if(true!=s[z]){y.load(d.appUrl+"/Play/showChnInfo",{chnid:d.chnid});s[z]=true}break;case 102:if(true!=s[z]){y.load(d.appUrl+"/WebChat3/webChat",{channelId:d.chnid});s[z]=true}break;case 104:if(true!=s[z]){y.load(d.appUrl+"/Play/vodlist",{chnid:d.chnid,vodid:d.vodid,playToken:d.playToken});s[z]=true}break;case 105:if(true!=s[z]){y.load(d.appUrl+"/Channel/showPhoto",{chnId:d.chnid});s[z]=true}break;case 106:if(true!=s[z]){y.load(d.appUrl+"/My/showMyInfo2",{chnid:d.chnid});s[z]=true}break;case 109:if(true!=s[z]){y.html("");$("#pictxt").appendTo(y);$("#pictxt").load(d.appUrl+"/FE_PicTxt/init",{chnid:d.chnid,programid:d.vodid});$("#pictxt").show();s[z]=true}break}});t.bind("tabActive",function(y,x,w){});var u=p.find(">div[tabid='"+q+"']").attr("taborder");if(typeof(u)=="undefined"){u=0}v(u)}({tabBar:"tabBar",tabBlk:"blkSouth",activetab:d.activetab});switch(d.forceLayer){case"register":var o={chnid:d.chnid,vidid:d.vodid,tab:d.activetab,agent:d.agent};$("#"+k.blkForceLayer).load(d.appUrl+"/Play/showChnRegister",o);break}if(d.forceLayer!="hide"){$("#"+k.blkForceLayer).show()}else{$("#"+k.blkForceLayer).hide()}this.popup=function(r,q,s){var p=$("#win_popup");if(null!=r){p.find(".win_notify").html(r)}if(null!=r){p.find("button").html(q)}p.show();p.find("button").on("click",function(){console.log("popup click");p.find("button").off("click");p.hide();if("function"==typeof s){s()}})};!function(q){var p=3600;var t=60;var u=10;q=parseInt(q);if(q<t*2){q=p}var s=q;var r=setInterval(function(){s-=u;console.log("idleTimrer countdown=",s);if(s<=t){g.popup("您已经观看很久了，请休息一会","再看一会儿",function(){s=q})}if(s<0){console.log("foce out===");c.stop();clearInterval(r);l.dispose();j.setOffline("web");j.setOffline("vod");j.setOffline("live");g.send({});g.popup("您太久没活动了，已被强制退出","到首页看看",function(){window.location.href=d.homeUrl})}},u*1000);$(window).on("touchstart click",function(){s=q})}(d.operatorIdleInt);this.getParam=function(){return d};var a=function(){if(d.playType=="live"){e()}$("title").text(d.title);g.setUrl()};setTimeout(function(){a()},500)};