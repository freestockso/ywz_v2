function Ou_Communicate(a){var b={backend:"",tokenName:"",tokenValue:"",lostCount:15};var d=$.extend(b,a);var c=d.lostCount;this.send=function(e,h){var g=new Date().getTime();var f={tokenName:d.tokenName,tokenValue:d.tokenValue,sendTime:g,playload:e};console.log("Communicate Send:",f);$.ajax({url:d.backend,type:"post",data:f,cache:false,async:true,dataType:"json",success:function(i){console.log("Communicate recv:",i);if(i.success=="false"){console.log(i.msg);if(c>0){c--}else{$(window).trigger("ServerLost")}}else{c=d.lostCount;$(window).trigger("RecvData",i);if(typeof h==="function"){h(i)}}},error:function(){if(c>0){c--}else{$(window).trigger("ServerLost")}console.log("Server lost :"+c);if(typeof h==="function"){h(null)}},complete:function(){console.log("Communicate delay(ms)="+(new Date().getTime()-g),typeof h)}})}}function Ou_playPage(d){var l={blkForceLayer:"blkForceLayer",blkAirTime:".layerVideoTop2 .blk_airTime",blkLeftTime:".layerVideoTop2 .blk_leftTime",layerVideoTop1:".layerVideoTop1",layerVideoTop2:".layerVideoTop2"};var f={tabScrolling:false,playerReady:false};var h=this;var i={};var k=function(){var q={};this.createOnline=function(x,w,v,u,s,t,r){q[x]={BEid:w,starttime:v,endtime:u,objtype:s,refid:t,FEobj:r};console.log(q)};this.getOnlineTable=function(){return q};this.setOnline=function(v,s,u,r){var t=parseInt((new Date()).getTime()/1000);console.log("setting online..",v,s,u);if(q[v]["starttime"]>0&&(t-q[v]["endtime"])<20&&q[v]["objtype"]==s&&q[v]["refid"]==u){q[v]["endtime"]=0}else{q[v]["BEid"]=0;q[v]["starttime"]=t;q[v]["endtime"]=0;q[v]["objtype"]=s;q[v]["refid"]=u;q[v]["FEobj"]=r}console.log(q)};this.setOffline=function(s){var r=parseInt((new Date()).getTime()/1000);console.log("setting offline..",s);if(q[s]["starttime"]>0){q[s]["endtime"]=r}console.log(q)};this.procFeedback=function(v){var u=Object.keys(q);var w=0;for(var t=0,r=u.length;t<r;t++){var s=u[t];if((q[s]["starttime"]==v[s]["starttime"])){if(v[s]["endtime"]==0){if(v[s]["BEid"]>0){q[s]["BEid"]=v[s]["BEid"]}if(v[s]["reject"]==true){w=(s=="web")?2:1}}else{q[s]["BEid"]=q[s]["starttime"]=q[s]["endtime"]=q[s]["FEobj"]=0}}}console.log("procFeedback output table: ",q);return w};return this}();function g(t,s){var q=null;s=parseInt(s)*1000;if(s<1000){s=10*1000}var r=function(){t();if(null!=q){clearTimeout(q)}q=setTimeout(r,s)};this.reset=function(){r()};this.stop=function(){if(null!=q){clearTimeout(q)}};this.reset();console.log("Ou_KeepAlive start.")}var b=parseInt((new Date()).getTime()/1000);k.createOnline("web",d.onlineid,b,0,"web",d.chnid,null);k.createOnline("live",0,0,0,"live",d.chnid,null);k.createOnline("vod",0,0,0,"vod",0,null);var n=new Ou_Communicate({backend:d.appUrl+"/BE_communicate/server",tokenName:"playToken",tokenValue:d.playToken});this.send=function(q,r){q.onlineTable=k.getOnlineTable();q.appPara=i;n.send(q,r)};this.setAppPara=function(r,q){if("undefined"==typeof(i[r])){i[r]={}}i[r]=$.extend(i[r],q)};var c=new g(function(){h.send({})},d.aliveTime);$(window).on("RecvData",function(q,s){console.log("recvData proc onlineTable");if("object"==typeof(s.onlineTable)){var r=k.procFeedback(s.onlineTable);console.log("reject=",r);if(1==r){m.pause();k.setOffline("vod");k.setOffline("live");h.send({});alert("已经暂停播放")}else{if(2==r){c.stop();m.dispose();k.setOffline("web");k.setOffline("vod");k.setOffline("live");h.send({});alert("您的账号从别的地方登录或被强制下线，若非本人操作，请立即修改密码！");window.location.href=d.homeUrl}}}});$(window).on("ServerLost",function(q){m.dispose();$("#"+l.blkForceLayer).show();$("#"+l.blkForceLayer).html("与服务器失去联系或通讯错误");c.stop()});if(!d.showCover){$("#blkCover").hide()}$("#btnEnterChannel").on("click",function(){$("#blkCover div").hide();$("#blkCover").animate({right:"100%"})});var o=function(q,r){var s={id:"prismPlayer",width:"100%",height:"100%",autoplay:false,isLive:true,skinLayout:[{name:"bigPlayButton",align:"blabs",x:30,y:80},{name:"H5Loading",align:"cc"},{name:"errorDisplay",align:"tlabs",x:0,y:0},{name:"infoDisplay"},{name:"tooltip",align:"blabs",x:0,y:56},{name:"thumbnail"},{name:"controlBar",align:"blabs",x:0,y:0,children:[{name:"progress",align:"blabs",x:0,y:44},{name:"playButton",align:"tl",x:15,y:12},{name:"timeDisplay",align:"tl",x:10,y:7},{name:"fullScreenButton",align:"tr",x:10,y:12}]}],rePlay:false,playsinline:true,preload:false,cover:"/t/1.jpg",controlBarVisibility:"click",useH5Prism:true,x5_fullscreen:true,x5_video_position:"top"};s=$.extend(s,r);if("live"==s.playType){s.isLive=true}else{s.isLive=false}return new Aliplayer(s,function(t){console.log("player ready!");f.playerReady=true;t.on("error",function(u){console.log("player error!!====",u,s.playType);k.setOffline(s.playType);$(".prism-ErrorMessage").hide();t.setCover(d.cover)});t.on("play",function(u){console.log("player play.====",s);$(l.layerVideoTop2).hide();if(s.isLive){k.setOnline("live","live",s.chnid,0);k.setOffline("vod")}else{k.setOnline("vod","vod",s.vodid,0);k.setOffline("live")}});t.on("pause",function(u){console.log("player pause.====",s.playType);k.setOffline(s.playType)});t.on("ended",function(u){console.log("player ended.====",s.playType);k.setOffline(s.playType)})})};console.log("befor init player.");var m=o("prismPlayer",d);console.log("status.playerReady=",f.playerReady);this.reloadPlayer=function(s,q,t,r){console.log("reloading player. type=",s,q,t,r,f.playerReady,typeof m);d.playType=s;d.source=q;d.cover=t;if("live"==s){d.chnid=r;d.vodid=0}else{d.vodid=r}if("object"==typeof m){m.pause();m.dispose()}m=o("prismPlayer",d)};this.getPlayer=function(){return m};var e=function(){if(d.airTime.length>2){if(d.isAdmin!=1){$(".blk_video .prism-big-play-btn").hide()}var r=new Date(d.airTime);var q=Math.floor(r.getTime()/1000);var s=setInterval(function(){var w=new Date();var v=Math.floor(w.getTime()/1000);var u=q-v;var t,A,z,x,B;if(u>0){z=Math.floor(u/3600);if(z<10){z="0"+z}x=Math.floor((u%3600)/60);if(x<10){x="0"+x}B=(u%3600)%60;if(B<10){B="0"+B}t=z+":"+x+":"+B;$(l.blkLeftTime).html("开播倒计时："+t);if(d.isAdmin!=1){$(".blk_video .prism-big-play-btn").hide()}}else{clearInterval(s);if(d.airDuration.length>1){var y=parseInt(d.airDuration);if(q+y>v){$(".blk_video .prism-big-play-btn").show()}else{$(l.blkLeftTime).html("直播已结束");if(d.isAdmin!=1){$(".blk_video .prism-big-play-btn").hide()}}}else{$(".blk_video .prism-big-play-btn").show()}}},1000)}};this.setUrl=function(){var q="play.html?ch="+d.chnid;if(d.playType=="vod"){q+="&vf="+d.vodid}if(d.uid>=100){q+="&du="+d.uid}console.log("url changed to=",q);history.replaceState(null,null,q+"#")};var j=function(s){console.log(s);var r=s.activetab;var q=$("#"+s.tabBar);var u=$("#"+s.tabBlk);var w=function(z){var y=u.width();console.log("scrollWidth="+y);var x=q.find(">div[tabOrder='"+z+"']").attr("tabid");x=parseInt(x);q.find(">div[tabid='"+r+"']").removeClass("tab-selected");r=x;q.find(">div[tabid='"+r+"']").addClass("tab-selected");f.tabScrolling=true;$("#blkSouth").animate({scrollLeft:(z*y)},300,function(){u.trigger("tabActive",[x,s]);setTimeout(function(){f.tabScrolling=false},100)})};q.on("click",function(x){var z=x.target;var y=$(z).attr("tabOrder");w(y)});u.scroll(function(){console.log("scroll even");if(f.tabScrolling){return}clearTimeout($.data(this,"scrollTimer"));$.data(this,"scrollTimer",setTimeout(function(){var z=u.scrollLeft();var x=u.width();var y=Math.round(z/x);w(y)},250))});var t={};u.bind("tabActive",function(B,A,x){var z=$("#"+d.tabItemPrefix+A);console.log("recive event:"+A);switch(A){case 101:console.log("101直播");if(true!=t[A]){$.ajaxSetup({async:true});z.load(d.appUrl+"/Play/showChnInfo",{chnid:d.chnid});t[A]=true}console.log("取直播播放地址及cover");var y={chnid:d.chnid,agent:d.agent,playToken:d.playToken};$.post(d.appUrl+"/Play/getLiveSourceJson",y,function(C){console.log("getLiveSourceJson",C);if(null==C){alert("错误: 无法访问服务器")}else{if(C.success!="true"){alert(C.msg)}else{h.reloadPlayer("live",C.source,C.cover,d.chnid)}}},"json");h.setUrl();$(l.layerVideoTop2).show();break;case 110:if(true!=t[A]){z.load(d.appUrl+"/Play/showChnInfo",{chnid:d.chnid});t[A]=true}break;case 102:if(true!=t[A]){z.load(d.appUrl+"/WebChat3/webChat",{channelId:d.chnid});t[A]=true}break;case 104:if(true!=t[A]){z.load(d.appUrl+"/Play/vodlist",{chnid:d.chnid,vodid:d.vodid,playToken:d.playToken});t[A]=true}break;case 105:if(true!=t[A]){z.load(d.appUrl+"/Channel/showPhoto",{chnId:d.chnid});t[A]=true}break;case 106:if(true!=t[A]){z.load(d.appUrl+"/My/showMyInfo2",{chnid:d.chnid});t[A]=true}break;case 109:if(true!=t[A]){z.html("");$("#pictxt").appendTo(z);$("#pictxt").load(d.appUrl+"/FE_PicTxt/init",{chnid:d.chnid,programid:d.vodid});$("#pictxt").show();t[A]=true}break}});u.bind("tabActive",function(z,y,x){});var v=q.find(">div[tabid='"+r+"']").attr("taborder");if(typeof(v)=="undefined"){v=0}w(v)}({tabBar:"tabBar",tabBlk:"blkSouth",activetab:d.activetab});switch(d.forceLayer){case"register":var p={chnid:d.chnid,vidid:d.vodid,tab:d.activetab,agent:d.agent};$("#"+l.blkForceLayer).load(d.appUrl+"/Play/showChnRegister",p);break}if(d.forceLayer!="hide"){$("#"+l.blkForceLayer).show()}else{$("#"+l.blkForceLayer).hide()}this.popup=function(s,r,t){var q=$("#win_popup");if(null!=s){q.find(".win_notify").html(s)}if(null!=s){q.find("button").html(r)}q.show();q.find("button").on("click",function(){console.log("popup click");q.find("button").off("click");q.hide();if("function"==typeof t){t()}})};!function(r){var q=3600;var u=60;var v=10;r=parseInt(r);if(r<u*2){r=q}var t=r;var s=setInterval(function(){t-=v;console.log("idleTimrer countdown=",t);if(t<=u){h.popup("您已经观看很久了，请休息一会","再看一会儿",function(){t=r})}if(t<0){console.log("foce out===");c.stop();clearInterval(s);m.dispose();k.setOffline("web");k.setOffline("vod");k.setOffline("live");h.send({});h.popup("您太久没活动了，已被强制退出","到首页看看",function(){window.location.href=d.homeUrl})}},v*1000);$(window).on("touchstart click",function(){t=r})}(d.operatorIdleInt);this.getParam=function(){return d};var a=function(){if(d.playType=="live"){e()}$("title").text(d.title)};setTimeout(function(){a()},500)};