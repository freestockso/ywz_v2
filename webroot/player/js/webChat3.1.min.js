function webChat(i){var e=this;var c={channelId:0,userName:"",userId:0,canChat:false,webpage:playPage,lastMsgId:0,firstMsgId:0,firstPageLoaded:false,unresponsive:false,continer:".wechat-container"};var b=$.extend(c,i);var f={blk_chatMsg:"#chatMsg",chatItem:"#msgItemTpl .chat-item"};var a=function(){var k=$(f.blk_chatMsg).scrollTop();if(0==k&&!b.unresponsive){b.unresponsive=true;if(true===b.firstPageLoaded){$(f.blk_chatMsg).prepend("<div class='loadmsg'>没有更多的数据了</div>");$(f.blk_chatMsg).off("scroll",a)}else{$(f.blk_chatMsg).prepend("<div class='loadmsg'>正在读入数据...</div>");var j=$(f.blk_chatMsg+" .loadmsg");j.fadeOut(2000,function(){j.remove();b.unresponsive=false});d("prev")}}};var g=function(n){var k=$(f.chatItem);var l=new Date(n.sendtime);var j=(new Date()).toDateString();var m=(l.toDateString()==j)?n.sendtime.substr(11,5):n.sendtime.substr(5,11);k.attr({msgid:n.id,senderid:n.senderid});k.find(".left-box").attr("sender",n.senderid);k.find(".right-box .msg-info span").html(n.sendername);k.find(".right-box .msg-info div").html(m);k.find(".right-box .msg-text xmp").html(n.message);console.log("head img=",n.headimg);if("undefined"!=typeof n.headimg){k.find(".left-box .bg-img").css("background-image","url("+n.headimg+")")}else{k.find(".left-box .bg-img").css("background-image","url(/Public/images/user.jpg)")}};$(window).on("RecvData",function(o,l){console.log("updateMsg recv:",l,"type of chat:",typeof l.chat);if("object"!=typeof l.chat){return}var q=l.chat;if(q.lastMsgId>b.lastMsgId){b.lastMsgId=q.lastMsgId}if(b.firstMsgId==0||q.firstMsgId<b.firstMsgId){b.firstMsgId=q.firstMsgId}var m={lastMsgId:b.lastMsgId,firstMsgId:b.firstMsgId};playPage.setAppPara("chat",m);if(q.total==0&&q.action=="prev"){b.firstPageLoaded=true}if(q.total>0){var p=q.rows;var k=$(f.chatItem);if(q.action=="prev"){for(var n=0,j=q.total;n<j;n++){g(p[n]);k.clone().prependTo(f.blk_chatMsg)}$(f.blk_chatMsg).scrollTop(5)}else{for(var n=q.total-1;n>=0;n--){g(p[n]);k.clone().appendTo(f.blk_chatMsg)}$(f.blk_chatMsg).scrollTop($(f.blk_chatMsg)[0].scrollHeight)}}});var d=function(k,l){var j={action:k,msg:l};playPage.send({chat:j})};this.sendMsg=function(j){if("1"!=b.canChat){alert("您无权发言！您没有登录或被禁言");return false}if(j.length<1){return false}d("send",j);return};$("#chatMsg").delegate(".chat-item .left-box","click",function(l){var k=$(this).attr("sender");if(k>0&&"1"==b.isAdmin){if(window.confirm("确定禁止此账号发言吗？")){var j={action:"mute",userid:k};playPage.send({chat:j})}}});$("#newMsg").on("click",function(l){var m=l.target;var k=$(m).attr("func");switch(k){case"send":$("#chat-bottom .popup-box").hide("fast");var n=$("#newMsg .input-box").html();e.sendMsg(n);$("#newMsg .input-box").html("");break;case"full":window.open("{$showfullurl}");break;case"emoji":$("#chat-bottom .popup-box").not("#emoji").hide();$("#emoji").toggle("normal");$("#newMsg .input-box").focus();var j=getSelection();if(typeof(lastEditRange)=="undefined"){e.setLastEditRange()}if(lastEditRange){j.removeAllRanges();j.addRange(lastEditRange)}break;case"gift":$("#chat-bottom .popup-box").not("#gift-list").hide();$("#gift-list").toggle("gift");break}});$("#newMsg .input-box").on("click keyup",function(){e.setLastEditRange();$("#emoji").hide("fast");return});$("#emoji ul").on("click",function(k){var l=k.target;if(l==k.delegateTarget){}else{var m=$(l).html();var j=$("#newMsg .input-box")[0];e.insertText(m,j)}});var h=function(){b.lastMsgId=0;b.firstMsgId=0;var j={channelId:b.channelId,userId:b.userId,lastMsgId:0,firstMsgId:0,isAdmin:b.isAdmin};playPage.setAppPara("chat",j);d("init");$(f.blk_chatMsg).on("scroll",a)};setTimeout(function(){h()},200)}webChat.prototype.insertText=function(h,f){var a={value:h};f.focus();var g=getSelection();if(lastEditRange){g.removeAllRanges();g.addRange(lastEditRange)}if(g.anchorNode.nodeName!="#text"){var j=document.createTextNode(a.value);if(f.childNodes.length>0){for(var c=0;c<f.childNodes.length;c++){if(c==g.anchorOffset){f.insertBefore(j,f.childNodes[c])}}}else{f.appendChild(j)}var d=document.createRange();d.selectNodeContents(j);d.setStart(j,j.length);d.collapse(true);g.removeAllRanges();g.addRange(d)}else{var d=g.getRangeAt(0);var b=d.startContainer;var e=d.startOffset;b.insertData(e,a.value);d.setStart(b,e+a.value.length);d.collapse(true);g.removeAllRanges();g.addRange(d)}lastEditRange=g.getRangeAt(0)};webChat.prototype.setLastEditRange=function(){var a=getSelection();lastEditRange=a.getRangeAt(0)};